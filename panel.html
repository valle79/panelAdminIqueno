<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Ique√±o SAC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #28a745; /* Verde tractor */
            --secondary: #ffc107; /* Amarillo tractor */
            --light: #f8f9fa;
            --dark: #343a40;
            --gradient: linear-gradient(90deg, #28a745 0%, #ffc107 100%);
        }

        body {
            background: var(--light);
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            overflow-x: hidden;
            margin: 0;
        }

        #sidebar-wrapper {
            width: 250px;
            background: var(--primary);
            color: white;
            position: fixed;
            height: 100vh;
            padding: 1.5rem 0;
            box-shadow: 2px 0 8px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }

        #sidebar-wrapper .logo-container {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }

        #sidebar-wrapper .logo {
            max-width: 220px;
            height: auto;
            transition: transform 0.2s;
        }

        #sidebar-wrapper .logo:hover {
            transform: scale(1.05);
        }

        #sidebar-wrapper .sidebar-title {
            font-size: 1.4rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 1.5rem;
            color: white;
            text-align: center;
        }

        #sidebar-wrapper .nav-link {
            color: white;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border-radius: 0 25px 25px 0;
            margin: 0.3rem 0;
            display: flex;
            align-items: center;
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }

        #sidebar-wrapper .nav-link i {
            margin-right: 0.75rem;
        }

        #sidebar-wrapper .nav-link.active,
        #sidebar-wrapper .nav-link:hover {
            background: rgba(255,255,255,0.25);
            color: var(--secondary);
            transform: translateX(5px);
        }

        #page-content-wrapper {
            margin-left: 250px;
            padding: 1.5rem;
            min-height: 100vh;
            transition: margin-left 0.3s ease-in-out;
            width: calc(100% - 250px);
        }

        .navbar {
            background: var(--gradient);
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 0.75rem 1rem;
            position: relative;
            z-index: 999;
        }

        .navbar .navbar-brand {
            display: flex;
            align-items: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            text-decoration: none;
            transition: transform 0.2s;
        }

        .navbar .navbar-brand img {
            max-height: 40px;
            margin-right: 0.75rem;
            transition: transform 0.2s;
        }

        .navbar .navbar-brand:hover img {
            transform: scale(1.05);
        }

        .navbar .navbar-brand:hover {
            transform: translateX(5px);
        }

        .navbar .navbar-text {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            margin-left: auto;
        }

        .navbar .hamburger {
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.3s ease-in-out;
            display: none;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .navbar .hamburger:hover {
            transform: translateY(-50%) scale(1.1);
            background: rgba(0,0,0,0.3);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 0.5rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        #advisors .card {
            border-left: 4px solid var(--primary);
        }

        #gallery .card {
            border-left: 4px solid var(--secondary);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            box-shadow: inset 2px 0 8px rgba(0,0,0,0.05), inset -2px 0 8px rgba(0,0,0,0.05);
            max-width: 100%;
            background: white;
        }

        .table {
            font-size: 0.85rem;
            width: 100%;
            min-width: 600px;
            table-layout: auto;
            border-collapse: separate;
            border-spacing: 0;
        }

        .table th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
            padding: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }

        .table td {
            vertical-align: middle;
            color: var(--dark);
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        .table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .table td:not(:first-child):not(:nth-child(3)) {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .table td:not(:first-child):not(:nth-child(3)):hover {
            overflow: visible;
            position: relative;
        }

        .table td:not(:first-child):not(:nth-child(3)) span {
            display: inline-block;
            white-space: nowrap;
        }

        .table td:not(:first-child):not(:nth-child(3)) span:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            position: absolute;
            z-index: 20;
        }

        .table-responsive::-webkit-scrollbar {
            height: 10px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #218838;
        }

        .btn-primary {
            background: var(--gradient);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            transition: background 0.2s, transform 0.2s;
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #218838 0%, #e0a800 100%);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: transform 0.2s;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-info {
            background: var(--secondary);
            border: none;
            border-radius: 8px;
            color: var(--dark);
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            transition: all 0.2s;
        }

        .btn-info:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #dc3545;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            transition: all 0.2s;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: var(--gradient);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1rem 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: none;
            padding: 1rem 1.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .form-label .fas {
            margin-right: 0.5rem;
            color: var(--primary);
        }

        .form-control, .form-control-file {
            border-radius: 8px;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus, .form-control-file:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
        }

        .custom-file-input {
            border: 2px dashed var(--primary);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            background: #fff;
            transition: background 0.2s, transform 0.2s;
            font-size: 0.9rem;
            position: relative;
        }

        .custom-file-input:hover {
            background: #f1f9f4;
            transform: scale(1.02);
        }

        .custom-file-input.dragover {
            background: #e6f3ea;
            border-color: var(--secondary);
        }

        .custom-file-input img.preview {
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 0.5rem;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-container {
            position: relative;
            display: inline-block;
            margin-top: 0.5rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .preview-container .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        .preview-container .remove-image:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .specialty-checkbox {
            margin-right: 1rem;
            margin-bottom: 0.5rem;
        }

        .specialty-checkbox .form-check-label {
            font-size: 0.9rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.6em;
        }

        .tooltip-icon {
            cursor: pointer;
            color: var(--primary);
            margin-left: 0.3rem;
        }

        .upload-progress {
            display: none;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--dark);
        }

        .spec-container, .feature-container {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .spec-item, .feature-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.3rem;
        }

        .spec-item button, .feature-item button {
            font-size: 0.8rem;
        }

        .dimension-input {
            width: 100px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            #sidebar-wrapper {
                transform: translateX(-250px);
                width: 250px;
                z-index: 1000;
            }

            #sidebar-wrapper.active {
                transform: translateX(0);
                box-shadow: 0 0 15px rgba(0,0,0,0.2);
            }

            #page-content-wrapper {
                margin-left: 0;
                width: 100%;
            }

            .navbar .hamburger {
                display: block;
            }

            .navbar .navbar-brand {
                font-size: 1rem;
            }

            .navbar .navbar-brand img {
                max-height: 30px;
            }

            .navbar .navbar-text {
                margin-left: 2.5rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 576px) {
            #page-content-wrapper {
                padding: 1rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
            }

            .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }

            .table {
                font-size: 0.8rem;
                min-width: 500px;
            }

            .modal-dialog {
                margin: 0.5rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .form-control, .custom-file-input {
                font-size: 0.85rem;
            }

            .custom-file-input img.preview {
                max-width: 60px;
                max-height: 60px;
            }

            .dimension-input {
                width: 80px;
            }

            .navbar .navbar-brand {
                font-size: 0.9rem;
            }

            .navbar .navbar-brand img {
                max-height: 25px;
            }

            .navbar .navbar-text {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="logo-container">
                <img src="assets/logo.png" alt="Ique√±o SAC Logo" class="logo">
            </div>
            <div class="sidebar-title">
                <i class="fa-solid fa-leaf me-2"></i> Fabricaciones & Servicios El Ique√±o
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#advisors"><i class="fas fa-users"></i> Asesores</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#gallery"><i class="fas fa-image"></i> Galer√≠a</a>
                </li>
                <li class="nav-item mt-4">
                    <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
                </li>
            </ul>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg mb-4 px-3">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <img src="assets/image.png" alt="Ique√±o SAC Logo" class="me-2">
                        Sistema de Control de Asesores y Productos <br>"Fabricaciones & Servicios El Ique√±o SAC"
                    </a>
                    <i class="fas fa-bars hamburger"></i>
                    <span class="navbar-text ms-auto">Bienvenido, <span id="user-name"></span></span>
                </div>
            </nav>

            <!-- Advisors Section -->
            <section id="advisors">
                <div class="section-title"><i class="fas fa-users"></i> Gesti√≥n de Asesores</div>
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fa-solid fa-user-tie"></i> Lista de Asesores</h5>
                        <button class="btn btn-primary" onclick="openAdvisorModal('add')"><i class="fa fa-plus"></i> Agregar Asesor</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Cargo</th>
                                    <th>WhatsApp</th>
                                    <th>Especialidades</th>
                                    <th>Imagen</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="advisors-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Gallery Section -->
            <section id="gallery">
                <div class="section-title"><i class="fas fa-image"></i> Gesti√≥n de Galer√≠a</div>
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fa-solid fa-boxes-stacked"></i> Lista de Productos</h5>
                        <button class="btn btn-primary" onclick="openGalleryModal('add')"><i class="fa fa-plus"></i> Agregar Producto</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripci√≥n</th>
                                    <th>Especificaciones</th>
                                    <th>Caracter√≠sticas</th>
                                    <th>Dimensiones</th>
                                    <th>Imagen</th>
                                    <th>PDF</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="gallery-table"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Advisor Modal -->
    <div class="modal fade" id="advisorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="advisorModalLabel">Agregar/Editar Asesor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="advisor-id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-user"></i> Nombre</label>
                            <input type="text" class="form-control" id="advisor-name" placeholder="Ej. Juan P√©rez" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fas fa-briefcase"></i> Cargo</label>
                            <input type="text" class="form-control" id="advisor-position" placeholder="Ej. T√©cnico Agr√≠cola" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><i class="fab fa-whatsapp"></i> WhatsApp</label>
                            <input type="text" class="form-control" id="advisor-whatsapp" placeholder="Ej. 987654321" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label"><i class="fas fa-tags"></i> Especialidades</label>
                            <div class="d-flex flex-wrap">
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-maquinaria" value="Maquinaria">
                                    <label class="form-check-label" for="spec-maquinaria">Maquinaria</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-tractores" value="Tractores">
                                    <label class="form-check-label" for="spec-tractores">Tractores</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-agricultura" value="Agricultura">
                                    <label class="form-check-label" for="spec-agricultura">Agricultura</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-proyectosEspeciales" value="Proyectos Especiales">
                                    <label class="form-check-label" for="spec-proyectosEspeciales">Proyectos Especiales</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-ServicioAlCliente" value="Servicio al Cliente">
                                    <label class="form-check-label" for="spec-ServicioAlCliente">Servicio al Cliente</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-administracion" value="Administracion">
                                    <label class="form-check-label" for="spec-administracion">Administracion</label>
                                </div>
                                <div class="form-check specialty-checkbox me-3">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-ventas" value="Ventas">
                                    <label class="form-check-label" for="spec-ventas">Ventas</label>
                                </div>
                                <div class="form-check specialty-checkbox">
                                    <input type="checkbox" class="form-check-input" name="specialties" id="spec-otros" value="Otros">
                                    <label class="form-check-label" for="spec-otros">Otros</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label"><i class="fas fa-image"></i> Imagen</label>
                            <div class="custom-file-input" onclick="document.getElementById('advisor-image-upload').click()">
                                <i class="fas fa-upload fa-2x"></i><br>
                                Haz clic aqu√≠ para subir una imagen
                            </div>
                            <input type="file" class="d-none" id="advisor-image-upload" accept="image/*">
                            <small id="advisor-image-preview" class="mt-2 d-block"></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="saveAdvisor()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="modal fade" id="galleryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="galleryModalLabel">Agregar/Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="product-id">
                    <div class="row g-3">
                        <!-- Nombre del Producto -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-box"></i> Nombre del Producto</legend>
                                <input type="text" class="form-control" id="product-name" placeholder="Ej. Cultivadora 3000" maxlength="100" required>
                                <div class="invalid-feedback">Por favor, ingrese un nombre (m√°ximo 100 caracteres).</div>
                                <small class="form-text text-muted">Nombre √∫nico para identificar el producto.</small>
                            </fieldset>
                        </div>
                        <!-- Descripci√≥n -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-align-left"></i> Descripci√≥n</legend>
                                <textarea class="form-control" id="product-description" placeholder="Ej. M√°quina para preparaci√≥n de suelos, ideal para cultivos intensivos" rows="3"></textarea>
                                <small class="form-text text-muted">Descripci√≥n breve del producto (opcional).</small>
                            </fieldset>
                        </div>
                        <!-- Especificaciones -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-list"></i> Especificaciones</legend>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" id="spec-label" placeholder="Ej. Potencia" maxlength="50">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" id="spec-value" placeholder="Ej. 100 HP" maxlength="100">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-primary w-100" onclick="addSpecification()"><i class="fas fa-plus"></i> A√±adir</button>
                                    </div>
                                </div>
                                <div id="specifications-list" class="spec-container"></div>
                                <small class="form-text text-muted">A√±ada especificaciones t√©cnicas (opcional).</small>
                            </fieldset>
                        </div>
                        <!-- Caracter√≠sticas -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-check-circle"></i> Caracter√≠sticas</legend>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-10">
                                        <input type="text" class="form-control" id="feature-input" placeholder="Ej. Alta durabilidad" maxlength="200">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-primary w-100" onclick="addFeature()"><i class="fas fa-plus"></i> A√±adir</button>
                                    </div>
                                </div>
                                <div id="features-list" class="feature-container"></div>
                                <small class="form-text text-muted">A√±ada caracter√≠sticas destacadas (opcional).</small>
                            </fieldset>
                        </div>
                        <!-- Dimensiones -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-ruler-combined"></i> Dimensiones</legend>
                                <div class="row g-2">
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Ancho (cm)</label>
                                        <input type="number" class="form-control dimension-input" id="dimension-width" placeholder="0" min="0" step="0.1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Alto (cm)</label>
                                        <input type="number" class="form-control dimension-input" id="dimension-height" placeholder="0" min="0" step="0.1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Profundidad (cm)</label>
                                        <input type="number" class="form-control dimension-input" id="dimension-depth" placeholder="0" min="0" step="0.1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Peso (kg)</label>
                                        <input type="number" class="form-control dimension-input" id="dimension-weight" placeholder="0" min="0" step="0.1">
                                    </div>
                                </div>
                                <small class="form-text text-muted">Dimensiones y peso del producto (opcional).</small>
                            </fieldset>
                        </div>
                        <!-- URL de PDF -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-file-pdf"></i> Ficha T√©cnica (PDF)</legend>
                                <input type="url" class="form-control" id="product-pdf" placeholder="Ej. https://ejemplo.com/ficha-tecnica.pdf">
                                <div class="invalid-feedback">Por favor, ingrese una URL v√°lida.</div>
                                <small class="form-text text-muted">Enlace al documento PDF (opcional).</small>
                            </fieldset>
                        </div>
                        <!-- Imagen del Producto -->
                        <div class="col-12">
                            <fieldset>
                                <legend class="form-label"><i class="fas fa-image"></i> Imagen del Producto</legend>
                                <div class="custom-file-input" id="product-image-dropzone">
                                    <i class="fas fa-upload fa-2x"></i><br>
                                    Arrastra una imagen aqu√≠ o haz clic para seleccionarla (JPG, PNG, GIF, m√°x. 5MB)
                                    <input type="file" class="d-none" id="product-image-upload" accept="image/jpeg,image/png,image/gif">
                                    <div class="upload-progress">Cargando... <span id="upload-progress-text"></span></div>
                                </div>
                                <div id="product-image-preview" class="mt-2"></div>
                                <small class="form-text text-muted">Imagen requerida para el producto.</small>
                            </fieldset>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="save-product-btn" onclick="saveProduct()" disabled>Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Inicializaci√≥n del cliente Supabase
        const { createClient } = window.supabase;
        const supabaseUrl = 'https://rqouqtdgxsksueyskdow.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxb3VxdGRneHNrc3VleXNrZG93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjgxNTcsImV4cCI6MjA2OTIwNDE1N30.7s3i-7gJw-MiI0473eR_3gVX5TrskpJ1ivZKglfeMk0';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        let currentUser = null;

        // Verificar autenticaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    console.error('No autenticado:', error);
                    window.location.href = 'index.html';
                } else {
                    currentUser = user;
                    document.getElementById('user-name').textContent = user.email || 'Usuario';
                    await loadAdvisors();
                    await loadProducts();

                    // Toggle sidebar on hamburger click
                    const hamburger = document.querySelector('.hamburger');
                    hamburger.addEventListener('click', () => {
                        document.getElementById('sidebar-wrapper').classList.toggle('active');
                    });

                    // Close sidebar when clicking outside on mobile
                    document.addEventListener('click', (e) => {
                        if (window.innerWidth <= 992 && !e.target.closest('#sidebar-wrapper') && !e.target.closest('.hamburger')) {
                            document.getElementById('sidebar-wrapper').classList.remove('active');
                        }
                    });

                    // Initialize tooltips
                    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                        new bootstrap.Tooltip(el);
                    });

                    // Drag and drop for image upload
                    const dropzone = document.getElementById('product-image-dropzone');
                    const input = document.getElementById('product-image-upload');
                    dropzone.addEventListener('click', () => input.click());
                    dropzone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropzone.classList.add('dragover');
                    });
                    dropzone.addEventListener('dragleave', () => {
                        dropzone.classList.remove('dragover');
                    });
                    dropzone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                        const files = e.dataTransfer.files;
                        if (files.length) {
                            if (validateImage(files[0])) {
                                input.files = files;
                                previewImage(files[0]);
                            }
                        }
                    });
                    input.addEventListener('change', () => {
                        if (input.files.length) {
                            if (validateImage(input.files[0])) {
                                previewImage(input.files[0]);
                            } else {
                                input.value = '';
                            }
                        }
                    });

                    // Validaci√≥n en tiempo real
                    document.getElementById('product-name').addEventListener('input', validateForm);
                    document.getElementById('product-pdf').addEventListener('input', validateForm);
                    document.getElementById('product-image-upload').addEventListener('change', validateForm);
                }
            } catch (err) {
                console.error('Error al verificar usuario:', err);
                window.location.href = 'index.html';
            }
        });

        // Validar imagen (tama√±o y formato)
        function validateImage(file) {
            const maxSize = 5 * 1024 * 1024; // 5MB
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                Swal.fire('Error', 'Solo se permiten im√°genes JPG, PNG o GIF.', 'error');
                return false;
            }
            if (file.size > maxSize) {
                Swal.fire('Error', 'La imagen no debe superar los 5MB.', 'error');
                return false;
            }
            return true;
        }

        // Image preview function
        function previewImage(file) {
            const preview = document.getElementById('product-image-preview');
            const reader = new FileReader();
            reader.onload = () => {
                preview.innerHTML = `
                    <div class="preview-container">
                        <img src="${reader.result}" alt="Preview" class="preview">
                        <button type="button" class="remove-image" onclick="removeImagePreview()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
            validateForm();
        }

        // Remove image preview
        function removeImagePreview() {
            const preview = document.getElementById('product-image-preview');
            const input = document.getElementById('product-image-upload');
            preview.innerHTML = '';
            input.value = '';
            validateForm();
        }

        // Validar formulario en tiempo real
        function validateForm() {
            const name = document.getElementById('product-name').value;
            const pdf = document.getElementById('product-pdf').value;
            const image = document.getElementById('product-image-upload').files.length;
            const saveBtn = document.getElementById('save-product-btn');

            // Validar nombre
            const nameValid = name && name.length <= 100;
            document.getElementById('product-name').classList.toggle('is-invalid', !nameValid);

            // Validar PDF
            const pdfValid = !pdf || /^(https?:\/\/)/i.test(pdf);
            document.getElementById('product-pdf').classList.toggle('is-invalid', !pdfValid);

            // Habilitar bot√≥n si nombre e imagen son v√°lidos
            saveBtn.disabled = !nameValid || !image;
        }

        // A√±adir especificaci√≥n
        function addSpecification() {
            const label = document.getElementById('spec-label').value.trim();
            const value = document.getElementById('spec-value').value.trim();
            if (!label || !value) {
                Swal.fire('Error', 'Por favor, complete ambos campos de especificaci√≥n.', 'error');
                return;
            }
            const list = document.getElementById('specifications-list');
            const specId = `spec-${Date.now()}`;
            const specItem = document.createElement('div');
            specItem.className = 'spec-item';
            specItem.innerHTML = `
                <span>${label}: ${value}</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            specItem.dataset.label = label;
            specItem.dataset.value = value;
            list.appendChild(specItem);
            document.getElementById('spec-label').value = '';
            document.getElementById('spec-value').value = '';
        }

        // A√±adir caracter√≠stica
        function addFeature() {
            const feature = document.getElementById('feature-input').value.trim();
            if (!feature) {
                Swal.fire('Error', 'Por favor, ingrese una caracter√≠stica.', 'error');
                return;
            }
            const list = document.getElementById('features-list');
            const featureId = `feature-${Date.now()}`;
            const featureItem = document.createElement('div');
            featureItem.className = 'feature-item';
            featureItem.innerHTML = `
                <span>${feature}</span>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            featureItem.dataset.feature = feature;
            list.appendChild(featureItem);
            document.getElementById('feature-input').value = '';
        }

        // Logout
        async function logout() {
            try {
                await supabase.auth.signOut();
                window.location.href = 'index.html';
            } catch (err) {
                console.error('Error al cerrar sesi√≥n:', err);
                Swal.fire('Error', 'No se pudo cerrar sesi√≥n', 'error');
            }
        }

        // Advisors CRUD
        async function loadAdvisors() {
            const { data, error } = await supabase
                .from('advisors')
                .select('id, name, position, whatsapp, specialties, image_url, deleted, created_at')
                .eq('deleted', false)
                .order('id', { ascending: true });
            if (error) {
                console.error('Error al cargar asesores:', error);
                Swal.fire('Error', 'No se pudo cargar asesores', 'error');
                return;
            }
            const table = document.getElementById('advisors-table');
            table.innerHTML = '';
            data.forEach(advisor => {
                let specialties = Array.isArray(advisor.specialties) ? advisor.specialties : [];
                if (typeof advisor.specialties === 'string') {
                    try {
                        specialties = JSON.parse(advisor.specialties);
                        if (!Array.isArray(specialties)) specialties = [];
                    } catch (e) {
                        console.error('Error parsing specialties:', e, 'Raw data:', advisor.specialties);
                        specialties = [];
                    }
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="white-space: nowrap;">${advisor.name || '-'}</td>
                    <td>${advisor.position || '-'}</td>
                    <td style="white-space: nowrap;">
                        <a href="https://wa.me/51${advisor.whatsapp || ''}" target="_blank" class="btn btn-success btn-sm">
                            <i class="fab fa-whatsapp"></i> ${advisor.whatsapp || '-'}
                        </a>
                    </td>
                    <td>
                        ${specialties.length > 0
                            ? specialties.map(s => `<span class="badge bg-primary me-1">${s}</span>`).join('')
                            : '<span class="text-muted">-</span>'}
                    </td>
                    <td>
                        <img src="${advisor.image_url || 'https://via.placeholder.com/40'}" alt="img" style="width:40px;height:40px;object-fit:cover;border-radius:50%;">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" onclick="editAdvisor(${advisor.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAdvisor(${advisor.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function openAdvisorModal(action, id = null) {
            const modal = new bootstrap.Modal(document.getElementById('advisorModal'));
            document.getElementById('advisor-id').value = id || '';
            document.getElementById('advisor-name').value = '';
            document.getElementById('advisor-position').value = '';
            document.getElementById('advisor-whatsapp').value = '';
            document.querySelectorAll('input[name="specialties"]').forEach(checkbox => checkbox.checked = false);
            document.getElementById('advisor-image-preview').textContent = '';
            document.getElementById('advisor-image-upload').value = '';
            document.getElementById('advisorModalLabel').textContent = id ? 'Editar Asesor' : 'Agregar Asesor';
            if (id) {
                supabase.from('advisors').select('id, name, position, whatsapp, specialties, image_url, deleted').eq('id', id).eq('deleted', false).single().then(({ data, error }) => {
                    if (error) {
                        console.error('Error fetching advisor:', error);
                    } else if (data) {
                        document.getElementById('advisor-name').value = data.name || '';
                        document.getElementById('advisor-position').value = data.position || '';
                        document.getElementById('advisor-whatsapp').value = data.whatsapp || '';
                        let specialties = Array.isArray(data.specialties) ? data.specialties : [];
                        if (typeof data.specialties === 'string') {
                            try {
                                specialties = JSON.parse(data.specialties);
                                if (!Array.isArray(specialties)) specialties = [];
                            } catch (e) {
                                console.error('Error parsing specialties:', e, 'Raw data:', data.specialties);
                                specialties = [];
                            }
                        }
                        document.querySelectorAll('input[name="specialties"]').forEach(checkbox => {
                            checkbox.checked = specialties.includes(checkbox.value);
                        });
                        if (data.image_url) {
                            document.getElementById('advisor-image-preview').innerHTML = `<img src="${data.image_url}" alt="Preview" style="max-width: 100px; max-height: 100px; object-fit: cover; margin-top: 10px;">`;
                        }
                    }
                });
            }
            modal.show();
        }

        async function saveAdvisor() {
            const id = document.getElementById('advisor-id').value;
            const name = document.getElementById('advisor-name').value;
            const position = document.getElementById('advisor-position').value;
            const whatsapp = document.getElementById('advisor-whatsapp').value;
            const specialties = Array.from(document.querySelectorAll('input[name="specialties"]:checked')).map(cb => cb.value);
            let image_url = '';

            if (document.getElementById('advisor-image-upload').files.length > 0) {
                const file = document.getElementById('advisor-image-upload').files[0];
                const fileName = `advisors/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const { error: uploadError } = await supabase.storage
                    .from('images')
                    .upload(fileName, file, { upsert: true });
                if (uploadError) {
                    console.error('Error uploading image:', uploadError.message);
                    Swal.fire('Error', `No se pudo subir la imagen: ${uploadError.message}`, 'error');
                    return;
                }
                const { data: publicUrlData } = supabase.storage
                    .from('images')
                    .getPublicUrl(fileName);
                image_url = publicUrlData.publicUrl;
            } else if (id) {
                const { data: existingData } = await supabase.from('advisors').select('image_url').eq('id', id).single();
                image_url = existingData?.image_url || '';
            } else {
                image_url = 'https://via.placeholder.com/40';
            }

            const advisor = {
                name,
                position,
                whatsapp,
                specialties: JSON.stringify(specialties),
                image_url,
                deleted: false
            };
            let result;
            try {
                if (id) {
                    result = await supabase
                        .from('advisors')
                        .update(advisor)
                        .eq('id', id)
                        .eq('deleted', false);
                } else {
                    result = await supabase
                        .from('advisors')
                        .insert(advisor);
                }
                if (result.error) {
                    console.error('Error saving advisor:', result.error);
                    Swal.fire('Error', 'No se pudo guardar el asesor', 'error');
                } else {
                    Swal.fire('Guardado', 'El asesor ha sido guardado correctamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('advisorModal')).hide();
                    await loadAdvisors();
                }
            } catch (err) {
                console.error('Excepci√≥n al guardar asesor:', err);
                Swal.fire('Error', 'Ocurri√≥ un error al guardar el asesor', 'error');
            }
        }

        async function editAdvisor(id) {
            openAdvisorModal('edit', id);
        }

        async function deleteAdvisor(id) {
            Swal.fire({
                title: '¬øEliminar asesor?',
                text: 'Esta acci√≥n no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await supabase
                        .from('advisors')
                        .update({ deleted: true })
                        .eq('id', id);
                    if (error) {
                        console.error('Error deleting advisor:', error);
                        Swal.fire('Error', 'No se pudo eliminar el asesor', 'error');
                    } else {
                        Swal.fire('Eliminado', 'El asesor ha sido eliminado', 'success');
                        await loadAdvisors();
                    }
                }
            });
        }

        // Gallery CRUD (machine_products)
        async function loadProducts() {
            const { data, error } = await supabase
                .from('machine_products')
                .select('id, name, description, image_url, pdf_url, specifications, features, dimensions, deleted, created_at')
                .eq('deleted', false)
                .order('id', { ascending: false });
            if (error) {
                console.error('Error al cargar productos:', error);
                Swal.fire('Error', 'No se pudo cargar productos', 'error');
                return;
            }
            const table = document.getElementById('gallery-table');
            table.innerHTML = '';
            data.forEach(product => {
                let specs = Array.isArray(product.specifications) ? product.specifications : [];
                if (typeof product.specifications === 'string') {
                    try { specs = JSON.parse(product.specifications); } catch (e) { console.error('Error parsing specifications:', e); specs = []; }
                }
                let features = Array.isArray(product.features) ? product.features : [];
                if (typeof product.features === 'string') {
                    try { features = JSON.parse(product.features); } catch (e) { console.error('Error parsing features:', e); features = []; }
                }
                let dims = typeof product.dimensions === 'object' && product.dimensions !== null ? product.dimensions : { width: 0, height: 0, depth: 0, weight: 0 };
                if (typeof product.dimensions === 'string') {
                    try { dims = JSON.parse(product.dimensions); } catch (e) { console.error('Error parsing dimensions:', e); dims = { width: 0, height: 0, depth: 0, weight: 0 }; }
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="white-space: nowrap;">${product.name || '-'}</td>
                    <td><span>${product.description || '-'}</span></td>
                    <td><span>${specs.length 
                        ? specs.map(s => `<span class="badge bg-info me-1">${s.label}: ${s.value}</span>`).join('') 
                        : '<span class="text-muted">-</span>'}</span></td>
                    <td><span>${features.length 
                        ? features.map(f => `<span class="badge bg-success me-1">${f}</span>`).join('') 
                        : '<span class="text-muted">-</span>'}</span></td>
                    <td><span>${Object.keys(dims).length 
                        ? `W: ${dims.width || 0}cm, H: ${dims.height || 0}cm, D: ${dims.depth || 0}cm, W: ${dims.weight || 0}kg`
                        : '<span class="text-muted">-</span>'}</span></td>
                    <td>
                        <img src="${product.image_url || 'https://via.placeholder.com/40'}" alt="img" style="width:40px;height:40px;object-fit:cover;border-radius:10px;">
                    </td>
                    <td>
                        ${product.pdf_url ? `<a href="${product.pdf_url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa fa-file-pdf"></i> PDF</a>` : '<span class="text-muted">-</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" onclick="editProduct(${product.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function openGalleryModal(action, id = null) {
            const modal = new bootstrap.Modal(document.getElementById('galleryModal'));
            document.getElementById('product-id').value = id || '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('spec-label').value = '';
            document.getElementById('spec-value').value = '';
            document.getElementById('feature-input').value = '';
            document.getElementById('dimension-width').value = '';
            document.getElementById('dimension-height').value = '';
            document.getElementById('dimension-depth').value = '';
            document.getElementById('dimension-weight').value = '';
            document.getElementById('product-pdf').value = '';
            document.getElementById('product-image-preview').innerHTML = '';
            document.getElementById('product-image-upload').value = '';
            document.getElementById('specifications-list').innerHTML = '';
            document.getElementById('features-list').innerHTML = '';
            document.getElementById('save-product-btn').disabled = true;
            document.getElementById('galleryModalLabel').textContent = id ? 'Editar Producto' : 'Agregar Producto';
            if (id) {
                supabase.from('machine_products').select('id, name, description, image_url, pdf_url, specifications, features, dimensions, deleted').eq('id', id).eq('deleted', false).single().then(({ data, error }) => {
                    if (error) {
                        console.error('Error fetching product:', error);
                    } else if (data) {
                        document.getElementById('product-name').value = data.name || '';
                        document.getElementById('product-description').value = data.description || '';
                        document.getElementById('product-pdf').value = data.pdf_url || '';
                        if (data.image_url) {
                            document.getElementById('product-image-preview').innerHTML = `
                                <div class="preview-container">
                                    <img src="${data.image_url}" alt="Preview" class="preview">
                                    <button type="button" class="remove-image" onclick="removeImagePreview()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                            document.getElementById('save-product-btn').disabled = !data.name;
                        }
                        // Cargar especificaciones
                        let specs = Array.isArray(data.specifications) ? data.specifications : [];
                        if (typeof data.specifications === 'string') {
                            try { specs = JSON.parse(data.specifications); } catch (e) { console.error('Error parsing specifications:', e); specs = []; }
                        }
                        specs.forEach(spec => {
                            const list = document.getElementById('specifications-list');
                            const specId = `spec-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                            const specItem = document.createElement('div');
                            specItem.className = 'spec-item';
                            specItem.innerHTML = `
                                <span>${spec.label}: ${spec.value}</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
                            `;
                            specItem.dataset.label = spec.label;
                            specItem.dataset.value = spec.value;
                            list.appendChild(specItem);
                        });
                        // Cargar caracter√≠sticas
                        let features = Array.isArray(data.features) ? data.features : [];
                        if (typeof data.features === 'string') {
                            try { features = JSON.parse(data.features); } catch (e) { console.error('Error parsing features:', e); features = []; }
                        }
                        features.forEach(feature => {
                            const list = document.getElementById('features-list');
                            const featureId = `feature-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                            const featureItem = document.createElement('div');
                            featureItem.className = 'feature-item';
                            featureItem.innerHTML = `
                                <span>${feature}</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
                            `;
                            featureItem.dataset.feature = feature;
                            list.appendChild(featureItem);
                        });
                        // Cargar dimensiones
                        let dims = typeof data.dimensions === 'object' && data.dimensions !== null ? data.dimensions : { width: 0, height: 0, depth: 0, weight: 0 };
                        if (typeof data.dimensions === 'string') {
                            try { dims = JSON.parse(data.dimensions); } catch (e) { console.error('Error parsing dimensions:', e); dims = { width: 0, height: 0, depth: 0, weight: 0 }; }
                        }
                        document.getElementById('dimension-width').value = dims.width || '';
                        document.getElementById('dimension-height').value = dims.height || '';
                        document.getElementById('dimension-depth').value = dims.depth || '';
                        document.getElementById('dimension-weight').value = dims.weight || '';
                    }
                });
            }
            modal.show();
        }

        async function saveProduct() {
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const pdf_url = document.getElementById('product-pdf').value;
            const specifications = Array.from(document.querySelectorAll('#specifications-list .spec-item')).map(item => ({
                label: item.dataset.label,
                value: item.dataset.value
            }));
            const features = Array.from(document.querySelectorAll('#features-list .feature-item')).map(item => item.dataset.feature);
            const dimensions = {
                width: parseFloat(document.getElementById('dimension-width').value) || 0,
                height: parseFloat(document.getElementById('dimension-height').value) || 0,
                depth: parseFloat(document.getElementById('dimension-depth').value) || 0,
                weight: parseFloat(document.getElementById('dimension-weight').value) || 0
            };

            // Validar campos requeridos
            if (!name) {
                document.getElementById('product-name').classList.add('is-invalid');
                Swal.fire('Error', 'El nombre del producto es requerido.', 'error');
                return;
            }
            if (!document.getElementById('product-image-upload').files.length && !id) {
                Swal.fire('Error', 'La imagen del producto es requerida.', 'error');
                return;
            }
            if (pdf_url && !/^(https?:\/\/)/i.test(pdf_url)) {
                document.getElementById('product-pdf').classList.add('is-invalid');
                Swal.fire('Error', 'Por favor, ingrese una URL v√°lida para el PDF.', 'error');
                return;
            }

            let image_url = '';
            if (document.getElementById('product-image-upload').files.length > 0) {
                const file = document.getElementById('product-image-upload').files[0];
                const fileName = `products/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                document.querySelector('.upload-progress').style.display = 'block';
                document.getElementById('upload-progress-text').textContent = 'Subiendo imagen...';
                const { error: uploadError } = await supabase.storage
                    .from('images')
                    .upload(fileName, file, { upsert: true });
                document.querySelector('.upload-progress').style.display = 'none';
                if (uploadError) {
                    console.error('Error uploading image:', uploadError);
                    Swal.fire('Error', 'No se pudo subir la imagen', 'error');
                    return;
                }
                const { data: publicUrlData } = supabase.storage
                    .from('images')
                    .getPublicUrl(fileName);
                image_url = publicUrlData.publicUrl;
            } else if (id) {
                const { data: existingData } = await supabase.from('machine_products').select('image_url').eq('id', id).single();
                image_url = existingData?.image_url || '';
            } else {
                image_url = 'https://via.placeholder.com/40';
            }

            const product = {
                name,
                description,
                image_url,
                pdf_url,
                specifications: JSON.stringify(specifications),
                features: JSON.stringify(features),
                dimensions: JSON.stringify(dimensions),
                deleted: false
            };
            let result;
            try {
                if (id) {
                    result = await supabase
                        .from('machine_products')
                        .update(product)
                        .eq('id', id)
                        .eq('deleted', false);
                } else {
                    result = await supabase
                        .from('machine_products')
                        .insert(product);
                }
                if (result.error) {
                    console.error('Error saving product:', result.error);
                    Swal.fire('Error', 'No se pudo guardar el producto', 'error');
                } else {
                    Swal.fire('Guardado', 'El producto ha sido guardado correctamente', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('galleryModal')).hide();
                    await loadProducts();
                }
            } catch (err) {
                console.error('Excepci√≥n al guardar producto:', err);
                Swal.fire('Error', 'Ocurri√≥ un error al guardar el producto', 'error');
            }
        }

        async function editProduct(id) {
            openGalleryModal('edit', id);
        }

        async function deleteProduct(id) {
            Swal.fire({
                title: '¬øEliminar producto?',
                text: 'Esta acci√≥n no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const { error } = await supabase
                        .from('machine_products')
                        .update({ deleted: true })
                        .eq('id', id);
                    if (error) {
                        console.error('Error deleting product:', error);
                        Swal.fire('Error', 'No se pudo eliminar el producto', 'error');
                    } else {
                        Swal.fire('Eliminado', 'El producto ha sido eliminado', 'success');
                        await loadProducts();
                    }
                }
            });
        }
    </script>
</body>
</html>